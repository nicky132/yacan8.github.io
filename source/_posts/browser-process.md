---
title: 浅谈浏览器多进程与JS线程
date: 2018-01-31 18:54:14
tags:
- 浏览器
- 进程
- js线程
---

## 引言
一直对浏览器的进程、线程的运行一无所知，经过一次的刷刷刷相关的博客之后，对其有了初步的了解，是时候该总结一波了。

## 进程、线程之间的关系
一个进程有一个或多个线程，线程之间共同完成进程分配下来的任务。打个比方：
> - 假如进程是一个工厂，工厂有它的独立的资源

> - 工厂之间相互独立

> - 线程是工厂中的工人，多个工人协作完成任务

> - 工厂内有一个或多个工人

> - 工人之间共享空间

再完善完善概念：

> - 工厂的资源 -> 系统分配的内存（独立的一块内存）

> - 工厂之间的相互独立 -> 进程之间相互独立

> - 多个工人协作完成任务 -> 多个线程在进程中协作完成任务

> - 工厂内有一个或多个工人 -> 一个进程由一个或多个线程组成

> - 工人之间共享空间 -> 同一进程下的各个线程之间共享程序的内存空间（包括代码段、数据集、堆等）

进程是cpu资源分配的最小单位（是能拥有资源和独立运行的最小单位），线程是cpu调度的最小单位（线程是建立在进程的基础上的一次程序运行单位）。

## 浏览器内的进程
知道了进程与线程之间的关系之后，下面是浏览器与进程的关系了。首先，浏览器是多进程的，之所以浏览器能够运行，是因为系统给浏览器分配了资源，如cpu、内存，简单的说就是，浏览器每打开一个标签页，就相当于创建了一个独立的浏览器进程。例如我们查看chrome里面的任务管理器。

** 注意：** 在这里浏览器应该也有自己的优化机制，有时候打开多个tab页后，可以在Chrome任务管理器中看到，有些进程被合并了（譬如打开多个空白标签页后，会发现多个空白标签页被合并成了一个进程），所以每一个Tab标签对应一个进程并不一定是绝对的。

除了浏览器的标签页进程之外，浏览器还有一些其他进程来辅助支撑标签页的进程，如下：
  ① Browser进程：浏览器的主进程（负责协调、主控），只有一个。作用有
  * 负责浏览器界面显示，与用户交互。如前进，后退等
  * 负责各个页面的管理，创建和销毁其他进程
  * 网络资源的管理，下载等

  ② 第三方插件进程：每种类型的插件对应一个进程，仅当使用该插件时才创建
  ③ GPU进程：最多一个，用于3D绘制等
  ④ 浏览器渲染进程（浏览器内核），Renderer进程，内部是多线程的，也就是我们每个标签页所拥有的进程，互不影响，负责页面渲染，脚本执行，事件处理等

如下图:

![browse-process1](/images/browse-process/browse-process1.jpg)

## 浏览器内核
浏览器内核，即我们的渲染进程，有名Renderer进程，我们页面的渲染，js的执行，事件的循环都在这一进程内进行，也就是说，该进程下面拥有着多个线程，靠着这些现成共同完成渲染任务。那么这些线程是什么呢，如下：

① 图形用户界面GUI渲染线程
  * 负责渲染浏览器界面，包括解析HTML、CSS、构建DOM树、Render树、布局与绘制等
  * 当界面需要重绘（Repaint）或由于某种操作引发回流(reflow)时，该线程就会执行

② JS线程
  * JS内核，也称JS引擎，负责处理执行javascript脚本
  * 等待任务队列的任务的到来，然后加以处理，浏览器无论什么时候都只有一个JS线程在运行JS程序

③ 事件触发线程
  * 听起来像JS的执行，但是其实归属于浏览器，而不是JS引擎，用来控制时间循环（可以理解，JS引擎自己都忙不过来，需要浏览器另开线程协助）
  * 当JS引擎执行代码块如setTimeout时（也可来自浏览器内核的其他线程,如鼠标点击、AJAX异步请求等），会将对应任务添加到事件线程中
  * 当对应的事件符合触发条件被触发时，该线程会把事件添加到待处理队列的队尾，等待JS引擎的处理
  * 注意，由于JS的单线程关系，所以这些待处理队列中的事件都得排队等待JS引擎处理（当JS引擎空闲时才会去执行）

④ 定时触发器线程
  * `setInterval`与`setTimeout`所在线程
